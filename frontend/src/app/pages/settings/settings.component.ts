import { CommonModule } from '@angular/common';
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, FormsModule, ReactiveFormsModule, Validators, AbstractControl, ValidationErrors } from '@angular/forms';
import Swal from 'sweetalert2';

interface UserSettings {
  firstName: string;
  lastName: string;
  email: string;
  emailNotifications: boolean;
  dailyReminders: boolean;
  theme: 'light' | 'dark';
  language: 'tr' | 'en';
}

@Component({
  selector: 'app-settings',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, FormsModule],
  templateUrl: './settings.component.html',
  styleUrls: ['./settings.component.scss']
})
export class SettingsComponent implements OnInit {
  userSettings: UserSettings = {
    firstName: 'Ahmet',
    lastName: 'Yƒ±lmaz',
    email: 'ahmet.yilmaz@example.com',
    emailNotifications: true,
    dailyReminders: false,
    theme: 'light',
    language: 'tr'
  };

  profileForm!: FormGroup;
  passwordForm!: FormGroup;
  settingsForm!: FormGroup;
  isPasswordFormValid: boolean = false;

  themes: { value: 'light' | 'dark', label: string, icon: string }[] = [
    { value: 'light', label: 'A√ßƒ±k Tema', icon: 'fas fa-sun' },
    { value: 'dark', label: 'Koyu Tema', icon: 'fas fa-moon' }
  ];

  languages: { value: 'tr' | 'en', label: string, icon: string }[] = [
    { value: 'tr', label: 'T√ºrk√ße', icon: 'üáπüá∑' },
    { value: 'en', label: 'English', icon: 'üá∫üá∏' }
  ];

  constructor(private fb: FormBuilder) {}

  ngOnInit(): void {
    this.initProfileForm();
    this.initPasswordForm();
    this.initSettingsForm();
  }

  private initProfileForm(): void {
    this.profileForm = this.fb.group({
      firstName: [this.userSettings.firstName, [Validators.required, Validators.minLength(2)]],
      lastName: [this.userSettings.lastName, [Validators.required, Validators.minLength(2)]],
      email: [this.userSettings.email, [Validators.required, Validators.email]]
    });
  }

  private initPasswordForm(): void {
    this.passwordForm = this.fb.group({
      currentPassword: ['', [Validators.required, Validators.minLength(6)]],
      newPassword: ['', [Validators.required, Validators.minLength(6), this.passwordStrengthValidator()]],
      confirmPassword: ['', [Validators.required]]
    }, { validators: this.passwordMatchValidator });

    // ≈ûifre formunun ge√ßerliliƒüini takip et
    this.passwordForm.valueChanges.subscribe(() => {
      this.isPasswordFormValid = this.passwordForm.valid;
    });
  }

  private initSettingsForm(): void {
    this.settingsForm = this.fb.group({
      emailNotifications: [this.userSettings.emailNotifications],
      dailyReminders: [this.userSettings.dailyReminders],
      theme: [this.userSettings.theme, Validators.required],
      language: [this.userSettings.language, Validators.required]
    });
  }

  // ≈ûifre g√º√ßl√ºl√ºk kontrol√º
  private passwordStrengthValidator(): (control: AbstractControl) => ValidationErrors | null {
    return (control: AbstractControl): ValidationErrors | null => {
      const password = control.value;
      if (!password) return null;

      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

      const errors: ValidationErrors = {};

      if (!hasUpperCase) errors['noUpperCase'] = true;
      if (!hasLowerCase) errors['noLowerCase'] = true;
      if (!hasNumbers) errors['noNumbers'] = true;
      if (!hasSpecialChar) errors['noSpecialChar'] = true;

      return Object.keys(errors).length > 0 ? errors : null;
    };
  }

  // ≈ûifre e≈üle≈üme kontrol√º
  private passwordMatchValidator(group: AbstractControl): ValidationErrors | null {
    const newPassword = group.get('newPassword')?.value;
    const confirmPassword = group.get('confirmPassword')?.value;

    return newPassword === confirmPassword ? null : { passwordMismatch: true };
  }

  // Profil bilgilerini g√ºncelle
  updateProfile(): void {
    if (this.profileForm.invalid) {
      Swal.fire({
        icon: 'warning',
        iconHtml: '‚ö†Ô∏è',
        title: 'Eksik Bilgi',
        text: 'L√ºtfen t√ºm alanlarƒ± doƒüru ≈üekilde doldurun.',
        background: '#fffbea',
        color: '#665c00',
        padding: '1.5em'
      });
      return;
    }

    const formValue = this.profileForm.value;
    this.userSettings = { ...this.userSettings, ...formValue };

    Swal.fire({
      icon: 'success',
      iconHtml: '‚úÖ',
      title: 'G√ºncellendi!',
      text: 'Profil bilgileriniz ba≈üarƒ±yla g√ºncellendi.',
      background: '#e8f5e9',
      color: '#1b5e20',
      padding: '1.5em',
      timer: 2000,
      showConfirmButton: false
    });
  }

  // ≈ûifre deƒüi≈ütir
  updatePassword(): void {
    if (this.passwordForm.invalid) {
      Swal.fire({
        icon: 'warning',
        iconHtml: '‚ö†Ô∏è',
        title: 'Eksik Bilgi',
        text: 'L√ºtfen t√ºm ≈üifre alanlarƒ±nƒ± doƒüru ≈üekilde doldurun.',
        background: '#fffbea',
        color: '#665c00',
        padding: '1.5em'
      });
      return;
    }

    const formValue = this.passwordForm.value;

    // ≈ûifre g√º√ßl√ºl√ºk kontrol√º
    const passwordErrors = this.passwordForm.get('newPassword')?.errors;
    if (passwordErrors) {
      let errorMessage = '≈ûifre a≈üaƒüƒ±daki kriterleri kar≈üƒ±lamalƒ±dƒ±r:\n';
      if (passwordErrors['noUpperCase']) errorMessage += '‚Ä¢ En az bir b√ºy√ºk harf\n';
      if (passwordErrors['noLowerCase']) errorMessage += '‚Ä¢ En az bir k√º√ß√ºk harf\n';
      if (passwordErrors['noNumbers']) errorMessage += '‚Ä¢ En az bir rakam\n';
      if (passwordErrors['noSpecialChar']) errorMessage += '‚Ä¢ En az bir √∂zel karakter\n';

      Swal.fire({
        icon: 'warning',
        iconHtml: '‚ö†Ô∏è',
        title: '≈ûifre G√ºvenliƒüi',
        text: errorMessage,
        background: '#fffbea',
        color: '#665c00',
        padding: '1.5em'
      });
      return;
    }

    // ≈ûifre e≈üle≈üme kontrol√º
    if (formValue.newPassword !== formValue.confirmPassword) {
      Swal.fire({
        icon: 'error',
        iconHtml: '‚ùå',
        title: '≈ûifre Uyu≈ümazlƒ±ƒüƒ±',
        text: 'Yeni ≈üifreler e≈üle≈ümiyor.',
        background: '#ffebee',
        color: '#b71c1c',
        padding: '1.5em'
      });
      return;
    }

    // ≈ûifre deƒüi≈ütirme i≈ülemi sim√ºlasyonu
    Swal.fire({
      icon: 'success',
      iconHtml: 'üîê',
      title: '≈ûifre Deƒüi≈ütirildi!',
      text: '≈ûifreniz ba≈üarƒ±yla g√ºncellendi.',
      background: '#e8f5e9',
      color: '#1b5e20',
      padding: '1.5em',
      timer: 2000,
      showConfirmButton: false
    });

    this.passwordForm.reset();
    this.isPasswordFormValid = false;
  }

  // Ayarlarƒ± g√ºncelle
  updateSettings(): void {
    if (this.settingsForm.invalid) {
      Swal.fire({
        icon: 'warning',
        iconHtml: '‚ö†Ô∏è',
        title: 'Eksik Bilgi',
        text: 'L√ºtfen t√ºm ayarlarƒ± se√ßin.',
        background: '#fffbea',
        color: '#665c00',
        padding: '1.5em'
      });
      return;
    }

    const formValue = this.settingsForm.value;
    this.userSettings = { ...this.userSettings, ...formValue };

    Swal.fire({
      icon: 'success',
      iconHtml: '‚öôÔ∏è',
      title: 'Ayarlar G√ºncellendi!',
      text: 'Ayarlarƒ±nƒ±z ba≈üarƒ±yla kaydedildi.',
      background: '#e3f2fd',
      color: '#0d47a1',
      padding: '1.5em',
      timer: 2000,
      showConfirmButton: false
    });
  }

  // ≈ûifre g√º√ßl√ºl√ºk seviyesini hesapla
  getPasswordStrength(): { level: number; label: string; color: string } {
    const password = this.passwordForm.get('newPassword')?.value;
    if (!password) return { level: 0, label: '≈ûifre girin', color: '#e0e0e0' };

    let strength = 0;
    if (password.length >= 6) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;

    const levels = [
      { label: '√áok Zayƒ±f', color: '#ff6b6b' },
      { label: 'Zayƒ±f', color: '#ffa726' },
      { label: 'Orta', color: '#ffd54f' },
      { label: 'G√º√ßl√º', color: '#66bb6a' },
      { label: '√áok G√º√ßl√º', color: '#43a047' }
    ];

    return { level: strength, ...levels[strength - 1] };
  }

  // ≈ûifre g√º√ßl√ºl√ºk y√ºzdesini hesapla
  getPasswordStrengthPercentage(): number {
    return (this.getPasswordStrength().level / 5) * 100;
  }

  // Form ge√ßerlilik kontrolleri
  get isProfileFormValid(): boolean {
    return this.profileForm.valid;
  }

  get isSettingsFormValid(): boolean {
    return this.settingsForm.valid;
  }

  // ≈ûifre gereksinimleri kontrol metodlarƒ±
  hasUpperCase(): boolean {
    const password = this.passwordForm.get('newPassword')?.value;
    return password ? /[A-Z]/.test(password) : false;
  }

  hasLowerCase(): boolean {
    const password = this.passwordForm.get('newPassword')?.value;
    return password ? /[a-z]/.test(password) : false;
  }

  hasNumbers(): boolean {
    const password = this.passwordForm.get('newPassword')?.value;
    return password ? /\d/.test(password) : false;
  }

  hasSpecialChar(): boolean {
    const password = this.passwordForm.get('newPassword')?.value;
    return password ? /[!@#$%^&*(),.?":{}|<>]/.test(password) : false;
  }

  // Tema deƒüi≈ütirme
  changeTheme(theme: 'light' | 'dark'): void {
    this.settingsForm.patchValue({ theme });
    this.userSettings.theme = theme;
    
    // Tema deƒüi≈üikliƒüi animasyonu
    document.body.style.transition = 'all 0.3s ease';
    if (theme === 'dark') {
      document.body.style.backgroundColor = '#1a1a1a';
      document.body.style.color = '#ffffff';
    } else {
      document.body.style.backgroundColor = '#ffffff';
      document.body.style.color = '#333333';
    }
  }

  // Dil deƒüi≈ütirme
  changeLanguage(language: 'tr' | 'en'): void {
    this.settingsForm.patchValue({ language });
    this.userSettings.language = language;
    
    Swal.fire({
      icon: 'info',
      iconHtml: 'üåç',
      title: 'Dil Deƒüi≈ütirildi',
      text: `Dil ${language === 'tr' ? 'T√ºrk√ße' : 'ƒ∞ngilizce'} olarak ayarlandƒ±.`,
      background: '#e3f2fd',
      color: '#0d47a1',
      padding: '1.5em',
      timer: 2000,
      showConfirmButton: false
    });
  }

  // T√ºm ayarlarƒ± sƒ±fƒ±rla
  resetAllSettings(): void {
    Swal.fire({
      title: 'Ayarlarƒ± Sƒ±fƒ±rla',
      text: 'T√ºm ayarlarƒ±nƒ±z varsayƒ±lan deƒüerlere d√∂nd√ºr√ºlecek. Bu i≈ülem geri alƒ±namaz.',
      icon: 'warning',
      iconHtml: '‚ö†Ô∏è',
      background: '#fff3e0',
      color: '#e65100',
      padding: '1.5em',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Sƒ±fƒ±rla',
      cancelButtonText: 'ƒ∞ptal',
      reverseButtons: true
    }).then(result => {
      if (result.isConfirmed) {
        this.userSettings = {
          firstName: 'Kullanƒ±cƒ±',
          lastName: 'Adƒ±',
          email: 'kullanici@example.com',
          emailNotifications: false,
          dailyReminders: false,
          theme: 'light',
          language: 'tr'
        };

        this.initProfileForm();
        this.initSettingsForm();

        Swal.fire({
          icon: 'success',
          iconHtml: 'üîÑ',
          title: 'Sƒ±fƒ±rlandƒ±!',
          text: 'T√ºm ayarlar varsayƒ±lan deƒüerlere d√∂nd√ºr√ºld√º.',
          background: '#e8f5e9',
          color: '#1b5e20',
          padding: '1.5em',
          timer: 2000,
          showConfirmButton: false
        });
      }
    });
  }
} 